trigger:
  branches:
    include:
    - main
    - test
    - features/*
  tags:
    include:
    - "*"    
  paths:
    include:
    - terraform/*

pool:
  name: ahpazuremanageddevops

variables:
  - ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/main') }}:    
    - template: variables/prd.yml
  - ${{ elseif eq(variables['Build.SourceBranch'], 'refs/heads/test') }}:    
    - template: variables/tst.yml
  - ${{ else }}:
    - template: variables/dev.yml

stages:
- stage: tf_bootstrap_storage
  variables:
    - group: ${{variables.keyVaultName}}
    - template: /variables/${{variables.env}}.yml
    - name: bootstrap_resource_group_name
      value: "tf-bootstrap-rg"
    - name: bootstrap_storage_account_name
      value: "tfbootstrapstorage"

  jobs:
    - job: bootstrap_storage
      displayName: Bootstrap Terraform State Storage
      steps:
        - task: TerraformInstaller@1
          inputs:
            version: 'latest'

        # Step 1: Check if backend configuration exists
        - script: |
            echo "Checking if backend storage account exists..."
            STORAGE_ACCOUNT_CHECK=$(az storage account show \
              --name $(bootstrap_storage_account_name) \
              --resource-group $(bootstrap_resource_group_name) \
              --query "name" --output tsv || echo "notfound")

            if [ "$STORAGE_ACCOUNT_CHECK" = "notfound" ]; then
              echo "Storage account does not exist."
              echo "##vso[task.setvariable variable=STORAGE_EXISTS]false"
            else
              echo "Storage account exists."
              echo "##vso[task.setvariable variable=STORAGE_EXISTS]true"
            fi
          displayName: Check Backend Storage

        
        - script: |
            echo "Initializing Terraform for bootstrap storage..."
            az account set -s $(dataPlatformSubscriptionName)
            cd $(System.DefaultWorkingDirectory)/terraform/tf-bootstrap-storage

            # Set Azure provider authentication variables
            export ARM_SUBSCRIPTION_ID=$(dataPlatformSubscriptionId)
            export ARM_CLIENT_ID=$(apdap-devops-sc-client-id)
            export ARM_CLIENT_SECRET=$(apdap-devops-sc-client-secret)
            export ARM_TENANT_ID="0d739c66-dcf8-4b06-87ab-9052bd918a5f"


            terraform init
            terraform plan -var-file="tfvars/$(env).tfvars" -out="$(System.DefaultWorkingDirectory)/$(Build.BuildId).tfplan"
            terraform apply -var-file="tfvars/$(env).tfvars" -auto-approve "$(System.DefaultWorkingDirectory)/$(Build.BuildId).tfplan"
          condition: and(succeeded(), eq(variables['STORAGE_EXISTS'], 'false'))
          displayName: Terraform Apply for Bootstrap Storage


        - script: |
            echo "Reinitializing Terraform with remote backend..."
            cd $(System.DefaultWorkingDirectory)/terraform/tf-bootstrap-storage
            terraform init \
              -reconfigure \
              -backend-config="resource_group_name=$(bootstrap_resource_group_name)" \
              -backend-config="storage_account_name=$(bootstrap_storage_account_name)" \
              -backend-config="container_name=$(bootstrap_container_name)" \
              -backend-config="key=tfstate/terraform.tfstate"

            terraform plan -var-file="tfvars/$(env).tfvars" -out=bootstrap.tfplan
            terraform apply -auto-approve bootstrap.tfplan
          displayName: Configure Remote Backend


        - script: |
            echo "Fetching backend configuration dynamically for use in next stage"
            cd $(System.DefaultWorkingDirectory)/terraform/tf-bootstrap-storage
            RESOURCE_GROUP=$(terraform output -raw resource_group_name)
            STORAGE_ACCOUNT=$(terraform output -raw storage_account_name)
            CONTAINER_NAME=$(terraform output -raw container_name)

            echo "##vso[task.setvariable variable=bootstrap_resource_group;isOutput=true]$RESOURCE_GROUP"
            echo "##vso[task.setvariable variable=bootstrap_storage_account;isOutput=true]$STORAGE_ACCOUNT"
            echo "##vso[task.setvariable variable=bootstrap_container_name;isOutput=true]$CONTAINER_NAME"
          name: stagevars
          displayName: Set Backend Configuration Variables


- stage: Terraform_run
  variables:
    - group: ${{variables.keyVaultName}}
    - template: /variables/${{variables.env}}.yml
  dependsOn: tf_bootstrap_storage
  jobs:
  - job: terraform_plan
    variables:
        bootstrap_resource_group: $[stageDependencies.tf_bootstrap_storage.bootstrap_storage.outputs['stagevars.bootstrap_resource_group']]
        bootstrap_storage_account: $[stageDependencies.tf_bootstrap_storage.bootstrap_storage.outputs['stagevars.bootstrap_storage_account']]
        bootstrap_container_name: $[stageDependencies.tf_bootstrap_storage.bootstrap_storage.outputs['stagevars.bootstrap_container_name']]
    displayName: Terraform State Management
    steps:
      - task: TerraformInstaller@1
        inputs:
          version: 'latest'

      - template: terraform/templates/terraform-plan.yml
        parameters:
          env: $(env)
          serviceConnection: $(serviceConnection)
          dataPlatformPrincipalId: $(apdap-devops-sc-client-id)
          dataPlatformPrincipalKey: $(apdap-devops-sc-client-secret)
          dataPlatformSubscriptionId: $(dataPlatformSubscriptionId)
          dataPlatformSubscriptionName: $(dataPlatformSubscriptionName)
          bootstrap_resource_group: $(bootstrap_resource_group)
          bootstrap_storage_account: $(bootstrap_storage_account)
          bootstrap_container_name: $(bootstrap_container_name)
          
      - template: terraform/templates/terraform-apply.yml
        parameters:
          env: $(env)
          serviceConnection: $(serviceConnection)
          dataPlatformPrincipalId: $(apdap-devops-sc-client-id)
          dataPlatformPrincipalKey: $(apdap-devops-sc-client-secret)
          dataPlatformSubscriptionId: $(dataPlatformSubscriptionId)
          dataPlatformSubscriptionName: $(dataPlatformSubscriptionName)
          bootstrap_resource_group: $(bootstrap_resource_group)
          bootstrap_storage_account: $(bootstrap_storage_account)
          bootstrap_container_name: $(bootstrap_container_name)
