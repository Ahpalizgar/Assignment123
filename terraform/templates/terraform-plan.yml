parameters:
  env:
  serviceConnection:
  dataPlatformPrincipalId:
  dataPlatformPrincipalKey:
  dataPlatformSubscriptionId:
  dataPlatformSubscriptionName:
  buildTag:

steps:          
  - task: AzureCLI@2
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo " ==== set Terraform values for using azure resources ====="

        export ARM_CLIENT_ID=${{ parameters.dataPlatformPrincipalId }}
        export ARM_CLIENT_SECRET=${{ parameters.dataPlatformPrincipalKey }}
        export ARM_TENANT_ID="0d739c66-dcf8-4b06-87ab-9052bd918a5f"
        export ARM_SUBSCRIPTION_ID=${{ parameters.dataPlatformSubscriptionId }}

        # Terraform steps 
        az account set -s ${{ parameters.dataPlatformSubscriptionName }}
        cd $(System.DefaultWorkingDirectory)/terraform

        terraform init -backend-config="backendconfigs/${{ parameters.env }}.hcl"
        terraform plan -var-file="tfvars/${{ parameters.env }}.tfvars" \
            -out="$(System.DefaultWorkingDirectory)/$(Build.BuildId).tfplan"
        
      addSpnToEnvironment: true
    displayName: Terraform plan
